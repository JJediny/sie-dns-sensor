####
#### Rough notes on setting up build environment schroots and rebuilding the
#### build-deps for sie-dns-sensor.
####
#### The host environment here is Debian 7 "wheezy".
####
#### Note that we build build environments for multiple architectures across
#### multiple distributions, but for sanity reasons we adopt the Debian names
#### for the various architectures where those names differ.
#### (That is, "i386" instead of "i686", "amd64" instead of "x86_64".)
####
#### Note that the build environment schroot tarballs generated by this
#### process contain binary artifacts from various Linux distributions.
#### They contain copylefted content and thus cannot be redistributed as-is,
#### so do not add them to the git tree.
####

### install schroot, sbuild, rinse packages

apt-get install sbuild schroot rinse

### move /var/lib/schroot onto the large (/srv) filesystem

root@rd2.iad1:/var/lib# mkdir /srv/schroot
root@rd2.iad1:/var/lib# mv schroot /srv/schroot/var
root@rd2.iad1:/var/lib# ln -s /srv/schroot/var schroot

### edit /srv/schroot/default/fstab and configure the /srv filesystem to be bindmounted into schroot sessions.

root@rd2.iad1:/etc/schroot# grep /srv default/fstab 
/srv        /srv        none    rw,bind     0   0

### create debian 7 amd64 schroot tarball.

root@rd2.iad1:~# sbuild-createchroot --arch=amd64 --make-sbuild-tarball=/srv/schroot/debian-7-amd64.tar.gz wheezy `mktemp -d` http://apt-cache.local-data.fsi.io:3142/debian
[...]
I: schroot chroot configuration written to /etc/schroot/chroot.d/wheezy-amd64-sbuild-dpYLtY.
   ┌────────────────────────────────────────────────────────────────────────
   │[wheezy-amd64-sbuild]
   │type=file
   │description=Debian wheezy/amd64 autobuilder
   │file=/srv/schroot/debian-7-amd64.tar.gz
   │groups=root,sbuild
   │root-groups=root,sbuild
   └────────────────────────────────────────────────────────────────────────
I: Please rename and modify this file as required.
[...]

### repeat, but for i386.

root@rd2.iad1:~# sbuild-createchroot --arch=i386 --make-sbuild-tarball=/srv/schroot/debian-7-i386.tar.gz wheezy `mktemp -d` http://apt-cache.local-data.fsi.io:3142/debian

### edited/renamed the chroot.d config files automatically generated in /etc/schroot/chroot.d.  now the chroot.d config files look like this:

root@rd2.iad1:~# cd /etc/schroot/chroot.d/
root@rd2.iad1:/etc/schroot/chroot.d# ls -1
debian-7-amd64
debian-7-i386
root@rd2.iad1:/etc/schroot/chroot.d# cat debian-7-amd64 
[debian-7-amd64]
type=file
description=Debian 7 wheezy/amd64
file=/srv/schroot/debian-7-amd64.tar.gz
groups=root
root-groups=root
root@rd2.iad1:/etc/schroot/chroot.d# cat debian-7-i386 
[debian-7-i386]
type=file
description=Debian wheezy/i386
file=/srv/schroot/debian-7-i386.tar.gz
groups=root
root-groups=root
personality=linux32
root@rd2.iad1:/etc/schroot/chroot.d# 

### make a backup copy of the schroot tarballs, just in case.

root@rd2.iad1:/srv/schroot# mkdir .orig
root@rd2.iad1:/srv/schroot# cp *.tar.gz .orig/

### "schroot -l" should list our new schroots:

root@rd2.iad1:~# schroot -l
chroot:debian-7-amd64
chroot:debian-7-i386
source:debian-7-amd64
source:debian-7-i386
root@rd2.iad1:~# 

### which we can enter with the "schroot -c" command.

### note that e.g. "schroot -c debian-7-amd64" will drop us into a throwaway environment based on the debian-7-amd64.tar.gz schroot tarball, while e.g. "schroot -c source:debian-7-amd64" will drop us into the "source" environment, that is once the environment is exited the directory tree will be written back into the tar.gz file.  see the "CHROOT NAMESPACES" section in the schroot(5) manpage for details.

### enter the debian source chroots and install the 'debhelper', 'pkg-config', 'zlib1g-dev', 'flex', and 'bison' packages.

root@rd2.iad1:~# schroot -c source:debian-7-amd64
(debian-7-amd64)root@rd2:~# apt-get --no-install-recommends install debhelper pkg-config zlib1g-dev flex bison && apt-get clean
[...]
(debian-7-amd64)root@rd2:~# logout

root@rd2.iad1:~# schroot -c source:debian-7-i386
(debian-7-i386)root@rd2:~# apt-get --no-install-recommends install debhelper pkg-config zlib1g-dev flex bison && apt-get clean
[...]
(debian-7-i386)root@rd2:~# logout

### now build the centos schroots. here we use the "rinse" command (debian package "rinse") to bootstrap the chroot directories. note: edit /etc/rinse/rinse.conf to set the mirror to a faster, closer mirror. (s/mirror.bytemark.co.uk/mirrors.kernel.org/g)  also note that the rinse command must be run under "linux32" when building i386 chroots on amd64 hosts.

root@rd2.iad1:/srv/schroot/tmp# rinse --distribution centos-5 --arch amd64 --directory ./centos-5-amd64
[...]
root@rd2.iad1:/srv/schroot/tmp# rinse --distribution centos-6 --arch amd64 --directory ./centos-6-amd64
[...]
root@rd2.iad1:/srv/schroot/tmp# linux32 rinse --distribution centos-5 --arch i386 --directory ./centos-5-i386
[...]
root@rd2.iad1:/srv/schroot/tmp# linux32 rinse --distribution centos-6 --arch i386 --directory ./centos-6-i386
[...]

### turn these centos directory trees into tarballs for schroot.

root@rd2.iad1:/srv/schroot/tmp# cd centos-5-amd64/
root@rd2.iad1:/srv/schroot/tmp/centos-5-amd64# tar -zcf ../../centos-5-amd64.tar.gz *
root@rd2.iad1:/srv/schroot/tmp/centos-5-amd64# cd ../centos-5-i386/
root@rd2.iad1:/srv/schroot/tmp/centos-5-i386# tar -zcf ../../centos-5-i386.tar.gz *
root@rd2.iad1:/srv/schroot/tmp/centos-5-i386# cd ../centos-6-amd64/
root@rd2.iad1:/srv/schroot/tmp/centos-6-amd64# tar -zcf ../../centos-6-amd64.tar.gz *
root@rd2.iad1:/srv/schroot/tmp/centos-6-amd64# cd ../centos-6-i386/
root@rd2.iad1:/srv/schroot/tmp/centos-6-i386# tar -zcf ../../centos-6-i386.tar.gz *
root@rd2.iad1:/srv/schroot/tmp/centos-6-i386# 

### the directory trees in .../tmp can now be deleted.

### create backup copies of the schroot tarballs, just in case.

root@rd2.iad1:/srv/schroot# cp centos-*.tar.gz .orig/

### create schroot.d config files for each of the centos schroot tarballs which look like this:

root@rd2.iad1:/etc/schroot/chroot.d# head -999 centos-*
==> centos-5-amd64 <==
[centos-5-amd64]
type=file
description=CentOS 5 amd64
file=/srv/schroot/centos-5-amd64.tar.gz
groups=root
root-groups=root

==> centos-5-i386 <==
[centos-5-i386]
type=file
description=CentOS 5 i386
file=/srv/schroot/centos-5-i386.tar.gz
groups=root
root-groups=root
personality=linux32

==> centos-6-amd64 <==
[centos-6-amd64]
type=file
description=CentOS 6 amd64
file=/srv/schroot/centos-6-amd64.tar.gz
groups=root
root-groups=root

==> centos-6-i386 <==
[centos-6-i386]
type=file
description=CentOS 6 i386
file=/srv/schroot/centos-6-i386.tar.gz
groups=root
root-groups=root
personality=linux32
root@rd2.iad1:/etc/schroot/chroot.d# 

### all of the debian and centos schroots should now be listed in the output of "schroot -l":

root@rd2.iad1:~# schroot -l
chroot:centos-5-amd64
chroot:centos-5-i386
chroot:centos-6-amd64
chroot:centos-6-i386
chroot:debian-7-amd64
chroot:debian-7-i386
source:centos-5-amd64
source:centos-5-i386
source:centos-6-amd64
source:centos-6-i386
source:debian-7-amd64
source:debian-7-i386
root@rd2.iad1:~# 

### now we need to install the build environment in each centos schroot.  we need to run "schroot -c source:centos[..]" for each of centos-5-amd64, centos-5-i386, centos-6-amd64, and centos-6-i386 and execute the following commands:

yum groupinstall 'Development Tools'
yum install zlib-devel
yum clean all

### however, centos-5-amd64 (centos 5.10) generates a fatal rpm transaction check error when installing openssl, see: http://www.hack.net.br/blog/2014/02/12/openssl-conflicts-with-file-from-package-openssl/. the solution was to run:

yum downgrade openssl
yum install openssl

### clone the sie-dns-sensor repo.

root@rd2:/srv# mkdir build
root@rd2:/srv# cd build/
root@rd2:/srv/build# git clone https://github.com/farsightsec/sie-dns-sensor.git

### update the binaries in the build-deps subdirectory.
### this has to be done by hand. TODO: automate and more thoroughly document this.

### output below is for debian-7-amd64. repeat for the other build environments, and commit the results into the git tree.

root@rd2.iad1:/srv/build/sie-dns-sensor/build-deps# schroot -c debian-7-amd64
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps# mkdir -p debian-7-amd64/dest

### rsync 3.1.0
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64# tar xf ../../tarballs/rsync_3.1.0.orig.tar.gz
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64# cd rsync-3.1.0/
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64/rsync-3.1.0# ./configure --prefix=/usr --disable-locale --disable-iconv-open --disable-iconv --disable-acl-support --disable-xattr-support --with-included-popt && make && make install DESTDIR=`pwd`/../dest/
[...]
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64/rsync-3.1.0# cd ../dest/
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64/dest# ls -l
total 4
drwxr-xr-x 4 root root 4096 Mar 10 18:34 usr
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64/dest# find . -type f -ls | sort
2103155 1600 -rwxr-xr-x   1 root     root      1635655 Mar 10 18:34 ./usr/bin/rsync
2228837  184 -rw-r--r--   1 root     root       184682 Mar 10 18:34 ./usr/share/man/man1/rsync.1
2228838   48 -rw-r--r--   1 root     root        47926 Mar 10 18:34 ./usr/share/man/man5/rsyncd.conf.5
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64/dest# mv usr/bin/rsync usr/bin/sie-rsync
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64/dest# strip usr/bin/sie-rsync 
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64/dest# rm -rf ./usr/share
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64/dest# find . -type f -ls
2103156  416 -rwxr-xr-x   1 root     root       424512 Mar 10 18:36 ./usr/bin/sie-rsync

### wrapsrv 0.2
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64# tar xf ../../tarballs/wrapsrv-0.2.tar.gz 
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64# cd wrapsrv-0.2/
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64/wrapsrv-0.2# make
gcc -O2 -g -Wall -Wextra -Werror -o wrapsrv wrapsrv.c  -lresolv
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64/wrapsrv-0.2# cp wrapsrv ../dest/usr/bin/sie-wrapsrv
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64/wrapsrv-0.2# strip ../dest/usr/bin/sie-wrapsrv 

### wdns 0.5
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64# tar xf ../../tarballs/wdns-0.5.tar.gz 
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64# cd wdns-0.5/
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64/wdns-0.5# ./configure --prefix=/usr --disable-shared --with-pic && make && make install DESTDIR=`pwd`/../dest/
[...]
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64/wdns-0.5# cd ../dest/
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64/dest# strip --strip-unneeded usr/lib/libwdns.a
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64/dest# rm usr/bin/wdns-test-*

### libpcap 1.3.0
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64# tar xf ../../tarballs/libpcap-1.3.0.tar.gz 
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64# cd libpcap-1.3.0/
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64/libpcap-1.3.0# ./configure --prefix=/usr --disable-bluetooth --disable-canusb --disable-can --without-libnl && make && make install DESTDIR=`pwd`/../dest/
[...]
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64/libpcap-1.3.0# cd ../dest/
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64/dest# rm -rf ./usr/share/
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64/dest# rm ./usr/lib/libpcap.so.1.3.0
(debian-7-amd64)root@rd2:/srv/build/sie-dns-sensor/build-deps/debian-7-amd64/dest# strip --strip-unneeded ./usr/lib/libpcap.a
